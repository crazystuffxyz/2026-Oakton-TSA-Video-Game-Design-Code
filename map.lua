-- map.lua
local map = {
    tileDimensions = 16,
    currentLevel = 1,
    data = {},
    width = 0,
    height = 0,
    playerStartX = 64,
    playerStartY = 64,
    levelTimer = 0,
    totalTimer = 0
}

map.sprites = {
    [1] = love.graphics.newImage("assets/_sky_1.png"), 
    [2] = love.graphics.newImage("assets/_floatingtile_2.png"),
    [3] = love.graphics.newImage("assets/_floor_3.png"),
    [4] = love.graphics.newImage("assets/_ladder_4.png"),
    [5] = love.graphics.newImage("assets/_wall_5.png"),[6] = love.graphics.newImage("assets/_levelend_6.png"),
    [7] = love.graphics.newImage("assets/_barrier_7.png"),
    [8] = love.graphics.newImage("assets/_ze_spike_8.png"),
}

-- ASCII Legend:
-- # = Wall (5)
-- . = Sky (1)
-- ^ = Spike (8)
-- ! = Win (6)
-- @ = Player Start
-- _ = Floor (3)
-- - = Floating (2)
-- = = Ladder (4)
-- | = Barrier (7)

local rawLevels = {
    [1] = {
        "####################",
        "#..................#",
        "#..................#",
        "#..................#",
        "#..................#",
        "#.@................#",
        "#######............#",
        "#.....#..._........#",
        "#.....#..._.....!..#",
        "#.....#..._#########",
        "#.....#..._........#",
        "####################",
        "Welcome: WASD to Move/Jump"
    },
    [2] = {
        "####################",
        "#..................#",
        "#..................#",
        "#..................#",
        "#.....###..........#",
        "#.....#.#.......!..#",
        "#.....#.#.......####",
        "#..@..#.#..........#",
        "#######.######.....#",
        "#..................#",
        "#..................#",
        "####################",
        "Charge Pulse (Hold Click) -> Aim at Feet"
    },
    [3] = {
        "##########################",
        "#........................#",
        "#........................#",
        "#........................#",
        "#....@................!..#",
        "######........############",
        "#....#^^^^^^^^#..........#",
        "#....##########..........#",
        "##########################",
        "Big Gap: Pulse Jump Across"
    },
    [4] = {
        "##########################",
        "#........................#",
        "#.....................!..#",
        "#.......#.#...........####",
        "#.......#.#..............#",
        "#..@....#.#...#.#........#",
        "#######.#.#...#.#.########",
        "#.......#.#...#.#.#......#",
        "#.......#.#...#.#.#......#",
        "##########################",
        "Wall Jumps: Jump against walls"
    },
    [5] = {
        "##########################",
        "#........................#",
        "#..!.....................#",
        "#######..................#",
        "#.....#..................#",
        "#.....#..................#",
        "#..@..#...===............#",
        "#######...===............#",
        "#.........===............#",
        "#.........===............#",
        "#^^^^^^^^^===^^^^^^^^^^^^#",
        "##########################",
        "Ladder Training"
    },
    [6] = {
        "#######################",
        "#.....................#",
        "#...................!.#",
        "#........#.....########",
        "#........#.....#......#",
        "#........#.....#......#",
        "#...@....#.....#......#",
        "#........#.....#......#",
        "#........#.....#......#",
        "##########.....#......#",
        "#..............#......#",
        "#^^^^^^^^^^^^^^#^^^^^^#",
        "#######################",
        "The Shaft: Pulse Vertical"
    },
    [7] = {
        "################################",
        "#..............................#",
        "#..............................#",
        "#............................!.#",
        "#.......................########",
        "#.......................#......#",
        "#........#..............#......#",
        "#........#..............#......#",
        "#...@....#.......#......#......#",
        "##########.......#......#......#",
        "#........#.......#......#......#",
        "#........#^^^^^^^#^^^^^^#......#",
        "#........#########......#......#",
        "#.......................#......#",
        "################################",
        "Teleporters: Q (Entry) / E (Exit)"
    },
    [8] = {
        "###################",
        "#.................#",
        "#.................#",
        "#.................#",
        "#.................#",
        "#..@.....#......!.#",
        "######...#......###",
        "######...#...#....#",
        "######.......#....#",
        "######.......#....#",
        "######^^^^^^^#....#",
        "######.......#....#",
        "######.......#....#",
        "######.......#....#",
        "###################",
        "Drop & Return: Teleport is 2-Way"
    },
    [9] = {
        "#################################",
        "#...............................#",
        "#...!...........................#",
        "#######............#.#..........#",
        "#.....#............#.#..........#",
        "#.....#............#.#..........#",
        "#.....#............#.#..........#",
        "#.....#............#.#..........#",
        "#.....#............#.#..........#",
        "#..@..#.....________.#..........#",
        "#######.....________.#..........#",
        "#^^^^^^^^^^^________.#..........#",
        "#################################",
        "The Gauntlet"
    },[10] = {
        "###################",
        "#.................#",
        "#..!..............#",
        "####..............#",
        "#..#..............#",
        "#..#..............#",
        "#..#...===........#",
        "#..#...===........#",
        "#..#...===........#",
        "#..#...===........#",
        "#..#...===........#",
        "#..#...===........#",
        "#..#...===........#",
        "#..@...===........#",
        "###################",
        "Ascension"
    },
    [11] = {
        "#################################",
        "#...............................#",
        "#.............................!.#",
        "#....#.#..#.#..#.#..#.#..########",
        "#....#.#..#.#..#.#..#.#.........#",
        "#..@.#.#..#.#..#.#..#.#.........#",
        "######.####.####.####.###########",
        "#^^^^#^^^^#^^^^#^^^^#^^^^^^^^^^^#",
        "#################################",
        "Pillars of Doom"
    },
    [12] = {
        "#################################",
        "#...............................#",
        "#...............................#",
        "#..@...........................!#",
        "####...........................##",
        "#..#...........................##",
        "#..#^^^^^^^^^^^^^^^^^^^^^^^^^^^##",
        "#..##############################",
        "#...............................#",
        "#...............................#",
        "#################################",
        "Leap of Faith - Momentum is conserved!"
    },
    [13] = {
        "################################",
        "#..............................#",
        "#!.............................#",
        "###.......######################",
        "#.#.......#....................#",
        "#.#.......#....................#",
        "#.#.......#...@................#",
        "#.#.......#####................#",
        "#.#...........#................#",
        "#.#########...#................#",
        "#^^^^^^^^^#....................#",
        "################################",
        "Drop & Warp"
    },
    [14] = {
        "##################################",
        "#................................#",
        "#..............................!.#",
        "#######.......................####",
        "#.....#...==.........==.......#..#",
        "#.....#...==.........==.......#..#",
        "#..@..#...==.........==.......#..#",
        "#######...==.........==.......#..#",
        "#.........==.........==.......#..#",
        "#^^^^^^^^^==^^^^^^^^^==^^^^^^^#..#",
        "##################################",
        "Monkey Bars"
    },
    [15] = {
        "##########################################",
        "#........................................#",
        "#........................................#",
        "#.................................==.....#",
        "#..@..............................==...!.#",
        "####.......................####...==.#####",
        "#..#...........|...........#..#...==.#...#",
        "#..#...........|...........#..#...==.#...#",
        "#..#############...........#..#...==.#...#",
        "#..............#...........#..#^^^^^^#...#",
        "#..............#^^^^^^^^^^^#..########...#",
        "#..............#############.............#",
        "##########################################",
        "The Final Test"
    }
}

function map.parseLevel(levelIndex)
    local raw = rawLevels[levelIndex] or rawLevels[1]
    map.data = {}
    map.width = 0
    map.height = #raw - 1 -- Last line is text
    
    for y = 1, map.height do
        local rowStr = raw[y]
        local rowData = {}
        map.width = math.max(map.width, #rowStr)
        for x = 1, #rowStr do
            local char = rowStr:sub(x,x)
            local id = 1 -- Default sky
            
            if char == "#" then id = 5 end
            if char == "_" then id = 3 end
            if char == "-" then id = 2 end
            if char == "!" then id = 6 end
            if char == "^" then id = 8 end
            if char == "=" then id = 4 end
            if char == "|" then id = 7 end
            if char == "@" then 
                map.playerStartX = (x-1) * 16
                map.playerStartY = (y-1) * 16
                id = 1
            end
            table.insert(rowData, id)
        end
        table.insert(map.data, rowData)
    end
    map.metadata = { tileDimensions = 16, currentLevel = levelIndex, name = raw[#raw] }
end

function map.resetLevel(player)
    player.x = map.playerStartX
    player.y = map.playerStartY
    player.xv = 0
    player.yv = 0
    player.teleportCooldown = 0
    map.levelTimer = 0
end

function map.nextLevel(player)
    map.currentLevel = map.currentLevel + 1
    if not rawLevels[map.currentLevel] then
        map.currentLevel = 1 -- Loop back
    end
    
    map.parseLevel(map.currentLevel)
    map.resetLevel(player)
    
    local teleporter = require("teleporter")
    teleporter.destroy()
    local pd = package.loaded["pulsedevice"]
    if pd then pd.reset() end
end

function map.load()
    map.parseLevel(1)
end

function map.draw()
    love.graphics.setColor(1,1,1)
    for row = 1, #map.data do
        for col = 1, #map.data[row] do
            local id = map.data[row][col]
            if id ~= 1 then
                local sprite = map.sprites[id]
                if sprite then
                    love.graphics.draw(sprite, (col-1)*16, (row-1)*16)
                end
            end
        end
    end
end

return map
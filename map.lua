-- map.lua
local map = {
    tileDimensions = 16,
    currentLevel = 1,
    maxLevels = 0,
    data = {},
    width = 0,
    height = 0,
    playerStartX = 64,
    playerStartY = 64,
    exitX = nil,
    exitY = nil,
    levelTimer = 0,
    totalTimer = 0,
    timeLeft = 0,
    totalGems = 0,
    levelGemsCollected = 0
}

map.sprites = {
    [1] = love.graphics.newImage("assets/_sky_1.png"), 
    [2] = love.graphics.newImage("assets/_floatingtile_2.png"),
    [3] = love.graphics.newImage("assets/_floor_3.png"),
    [4] = love.graphics.newImage("assets/_ladder_4.png"),
    [5] = love.graphics.newImage("assets/_wall_5.png"),[6] = love.graphics.newImage("assets/_levelend_6.png"),
    [7] = love.graphics.newImage("assets/_barrier_7.png"),
    [8] = love.graphics.newImage("assets/_ze_spike_8.png"),
    [9] = love.graphics.newImage("assets/_wall_breakable.png"),
}

-- ASCII Legend:
-- # = Wall (5)
-- . = Sky (1)
-- ^ = Spike Up (8)
-- < = Spike Left (11)
-- > = Spike Right (12)
-- v/V = Spike Down (13)
-- ! = Win (6)
-- @ = Player Start
-- _ = Floor (3)
-- - = Floating (2)
-- = = Ladder (4)
-- | = Barrier (7)
-- X = Breakable Wall (9)
-- G = Gem (10)

local rawLevels = {
    [1] = {
        "####################",
        "#..................#",
        "#..................#",
        "#..................#",
        "#..................#",
        "#.@.............G..#",
        "#######............#",
        "#.....#..._........#",
        "#.....#..._.....!..#",
        "#.....#..._#########",
        "#.....#..._........#",
        "####################",
        "Welcome: WASD to Move/Jump"
    },
    [2] = {
        "####################",
        "#..................#",
        "#..................#",
        "#..................#",
        "#.....###.......G..#",
        "#.....#.#.......!..#",
        "#.....#.#.......####",
        "#..@..#.#..........#",
        "#######.######.....#",
        "#..................#",
        "#..................#",
        "####################",
        "Charge Pulse (Hold Click) -> Aim at Feet"
    },
    [3] = {
        "##########################",
        "#........................#",
        "#...............G........#",
        "#.......X................#",
        "#....@..X.............!..#",
        "######..X.....############",
        "#....#^^^^^^^^#..........#",
        "#....##########..........#",
        "##########################",
        "Break Walls: Shoot them!"
    },
    [4] = {
        "##########################",
        "#.......G................#",
        "#.......#.#...........!..#",
        "#.......#.#...........####",
        "#.......#.#...X..........#",
        "#..@....#.#...X.#........#",
        "#######.#.#...X.#.########",
        "#.......#.#...X.#.#......#",
        "#.......#.#...#.#.#......#",
        "##########################",
        "Wall Jumps: Jump against walls"
    },
    [5] = {
        "##########################",
        "#........................#",
        "#.......G................#",
        "#.....###................#",
        "#.....#..................#",
        "#.....#.........!........#",
        "#..@..#...===X...........#",
        "#######...===X...........#",
        "#.........===X...........#",
        "#.........===X...........#",
        "#^^^^^^^^^===^^^^^^^^^^^^#",
        "##########################",
        "Ladder Training"
    },
    [6] = {
        "#######################",
        "#................G....#",
        "#...................!.#",
        "#........X.....########",
        "#........X.....#......#",
        "#........X.....#......#",
        "#...@....X.....#......#",
        "#........X.....#......#",
        "#........X.....#......#",
        "##########.....#......#",
        "#..............#......#",
        "#^^^^^^^^^^^^^^#^^^^^^#",
        "#######################",
        "The Shaft: Pulse Vertical"
    },
    [7] = {
        "################################",
        "#..............................#",
        "#................G.............#",
        "#............................!.#",
        "#.......................########",
        "#.......................#......#",
        "#........#..............#......#",
        "#........X..............#......#",
        "#...@....X.......X......#......#",
        "##########.......#......#......#",
        "#........#.......#......#......#",
        "#........#^^^^^^^#^^^^^^#......#",
        "#........#########......#......#",
        "#.......................#......#",
        "################################",
        "Teleporters: Q (Entry) / E (Exit)"
    },
    [8] = {
        "###################",
        "#.................#",
        "#.......G.........#",
        "#.......X.........#",
        "#.......X.........#",
        "#..@....X#......!.#",
        "######...#......###",
        "######...#...#....#",
        "######.......#....#",
        "######.......#....#",
        "######^^^^^^^#....#",
        "######.......#....#",
        "######.......#....#",
        "######.......#....#",
        "###################",
        "Drop & Return: Teleport is 2-Way"
    },
    [9] = {
        "#################################",
        "#...............................#",
        "#....X............G.............#",
        "##...#.............#.#..........#",
        "#....#......X......#.#..........#",
        "#...##.............#.#..........#",
        "#....#.............#.#..........#",
        "##...#.............#.#..........#",
        "#....#.............#.#..........#",
        "#..@.#......________.#..........#",
        "#######.....________.#..........#",
        "#^^^^^^^^^^^________.#.........!#",
        "#################################",
        "The Gauntlet"
    },
    [10] = {
        "###################",
        "#.................#",
        "#!...======.......#",
        "##...======.......#",
        "#.................#",
        "#..........X......#",
        "#..@.......X....G.#",
        "#..........X......#",
        "#..........X......#",
        "###################",
        "Ascension"
    },
    [11] = {
        "#################################",
        "#G.............................G#",
        "#.............................!.#",
        "#....#.#..#.#..#.#..#.#..########",
        "#....#X#..#X#..#X#..#X#.........#",
        "#..@.#.#..#.#..#.#..#.#.........#",
        "######.####.####.####.###########",
        "#^^^^#^^^^#^^^^#^^^^#^^^^^^^^^^^#",
        "#################################",
        "Pillars of Doom"
    },
    [12] = {
        "#################################",
        "#...................X...........#",
        "#...................X......G....#",
        "#..@................X...........#",
        "####................XX^^^^XX....#",
        "#..#................XXXXXXXX....#",
        "#..#^^^^^^^^^^^^^^^^^^^^^^^^^^^.#",
        "#..############################.#",
        "#..#...#...#...#...#...#...#....#",
        "#!...#...#...#...#...#...#...####",
        "#################################",
        "Leap of Faith - Break mid-air!"
    },
    [13] = {
        "################################",
        "#..............................#",
        "#!...................G.........#",
        "###..................#.........#",
        "#.#..................X.........#",
        "#.#.......G..........X.........#",
        "#.#.......#..........X.........#",
        "#.#.......X...@......X.........#",
        "#.#.......X...#......X.........#",
        "#.#########...########.........#",
        "#^^^^^^^^^#....................#",
        "################################",
        "Teleporter Pit (R to Reset!)"
    },
    [14] = {
        "##################################",
        "#..==============================#",
        "#..=....................G.=....!.#",
        "###.###.................===...####",
        "#.....#.......................#..#",
        "#.....#.......................#..#",
        "#..@..#.......................#..#",
        "#######.......................#..#",
        "#.............................#..#",
        "#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^#..#",
        "##################################",
        "Monkey Bars"
    },
    [15] = {
        "##########################################",
        "#..............VV.G.VV............GG.....#",
        "#..............VV.=.VV...........XXXX....#",
        "#.................=.............XX^^XX...#",
        "#.................=............XX^^^^XX...#",
        "#.................=...........XX^^^^^^XX..#",
        "#.................=..........XX^^^^^^^^XX!#",
        "#.................=.........XX^^^^^^^^^^XX#",
        "#..........##.############################",
        "#..........##.############################",
        "#..........##.############################",
        "#..........##.....########################",
        "#..........######.....................G..#",
        "#..........######.########################",
        "#..........######.#G#G#............#G##G##",
        "#..........######.#.#.#.##########.#.##.##",
        "#..........######.#.#.#.#G.........#.##.##",
        "#..........######.#.#.#.############.##.##",
        "#..........######........................#",
        "#..........###############################",
        "#.....#....#.............................#",
        "#.....#....#.............................#",
        "#.....#>...#.............................#",
        "#....<#....#.............................#",
        "#.....#....#.............................#",
        "#.....#....#.............................#",
        "#>....#...<#.............................#",
        "#.....#....#.............................#",
        "#.....#....#.............................#",
        "#.....#>...#.............................#",
        "#....<#....#.............................#",
        "#.....#....#.............................#",
        "#.....#....#.............................#",
        "#>.@..#GGGG#.............................#",
        "##########################################",
        "The Final Test"
    }
}

function map.parseLevel(levelIndex)
    local raw = rawLevels[levelIndex] or rawLevels[1]
    map.maxLevels = #rawLevels
    map.data = {}
    map.width = 0
    map.height = #raw - 1 -- Last line is text
    map.totalGems = 0
    map.levelGemsCollected = 0
    map.exitX = nil
    map.exitY = nil
    
    for y = 1, map.height do
        local rowStr = raw[y]
        local rowData = {}
        map.width = math.max(map.width, #rowStr)
        for x = 1, #rowStr do
            local char = rowStr:sub(x,x)
            local id = 1 -- Default sky
            
            if char == "#" then id = 5 end
            if char == "_" then id = 3 end
            if char == "X" or char == "x" then id = 9 end
            if char == "-" then id = 2 end
            if char == "!" then 
                id = 6 
                map.exitX = (x-1) * 16
                map.exitY = (y-1) * 16
            end
            if char == "^" then id = 8 end
            if char == "<" then id = 11 end
            if char == ">" then id = 12 end
            if char == "v" or char == "V" then id = 13 end
            if char == "=" then id = 4 end
            if char == "|" then id = 7 end
            if char == "G" then 
                id = 10 
                map.totalGems = map.totalGems + 1
            end
            if char == "@" then 
                map.playerStartX = (x-1) * 16
                map.playerStartY = (y-1) * 16
                id = 1
            end
            table.insert(rowData, id)
        end
        table.insert(map.data, rowData)
    end
    map.metadata = { tileDimensions = 16, currentLevel = levelIndex, name = levelIndex .. " - " .. raw[#raw] }
end

function map.resetLevel(player)
    -- Re-parse the level to reset all blocks and gems
    map.parseLevel(map.currentLevel)
    player.x = map.playerStartX
    player.y = map.playerStartY
    player.xv = 0
    player.yv = 0
    player.teleportCooldown = 0
    player.stunTimer = 0
    map.levelTimer = 0
    
    local burned = package.loaded["burned"]
    if burned then 
        burned.reset() 
        if map.currentLevel < map.maxLevels-3 and map.exitX and map.exitY then
            burned.spawn(map.exitX + 4, map.exitY + 4)
        end
    end
end

function map.nextLevel(player)
    map.currentLevel = map.currentLevel + 1
    if not rawLevels[map.currentLevel] then
        _G.gameState = "ending"
        map.currentLevel = 1 -- Reset for next playthrough
        return
    end
    
    map.timeLeft = map.currentLevel * 60
    map.resetLevel(player)
    
    local teleporter = require("teleporter")
    teleporter.destroy()
    local pd = package.loaded["pulsedevice"]
    if pd then pd.reset() end
end

function map.load()
    map.parseLevel(1)
end

function map.draw()
    love.graphics.setColor(1,1,1)
    for row = 1, #map.data do
        for col = 1, #map.data[row] do
            local id = map.data[row][col]
            if id == 10 then
                -- Draw Gem (Code only)
                local cx = (col-1)*16 + 8
                local cy = (row-1)*16 + 8 + math.sin(love.timer.getTime() * 4 + col) * 2
                love.graphics.setColor(0, 1, 0.5)
                love.graphics.polygon("fill", cx, cy-6, cx+4, cy, cx, cy+6, cx-4, cy)
                love.graphics.setColor(1, 1, 1)
            elseif id ~= 1 then
                if id == 8 or id == 11 or id == 12 or id == 13 then
                    local sprite = map.sprites[8]
                    if sprite then
                        local angle = 0
                        if id == 11 then angle = -math.pi/2 end
                        if id == 12 then angle = math.pi/2 end
                        if id == 13 then angle = math.pi end
                        love.graphics.draw(sprite, (col-1)*16 + 8, (row-1)*16 + 8, angle, 1, 1, 8, 8)
                    end
                else
                    local sprite = map.sprites[id]
                    if sprite then
                        love.graphics.draw(sprite, (col-1)*16, (row-1)*16)
                    end
                end
            end
        end
    end
end

return map